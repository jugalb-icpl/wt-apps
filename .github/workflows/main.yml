name: Docker Image CI

on:
  push:
    branches: [ "master" ]

env:
  DOCKER_USERNAME: jugalb
  DOCKER_REPO: wt-apps
  DOCKER_IMG_CLIENT: client
  DOCKER_IMG_SERVER: server

jobs:
  build-and-push:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Log in to Docker Hub
      env:
        DOCKER_PASSWORD: ${{ secrets.DOCKERPW }}
      run: docker login -u "${{ env.DOCKER_USERNAME }}" -p $DOCKER_PASSWORD

    - name: Get the latest tag for server and client images
      id: get_versions
      run: |
        # Fetch the latest tag or default to v0 if not found
        SERVER_LATEST_TAG=$(docker pull jugalb/${{ env.DOCKER_REPO }}:${{ env.DOCKER_IMG_SERVER }} || echo "v0")
        CLIENT_LATEST_TAG=$(docker pull jugalb/${{ env.DOCKER_REPO }}:${{ env.DOCKER_IMG_CLIENT }} || echo "v0")

        # Extract version numbers
        SERVER_VERSION=$(echo $SERVER_LATEST_TAG | grep -oP '\d+' || echo "0")
        CLIENT_VERSION=$(echo $CLIENT_LATEST_TAG | grep -oP '\d+' || echo "0")

        # Increment the versions
        SERVER_NEW_VERSION=$((SERVER_VERSION + 1))
        CLIENT_NEW_VERSION=$((CLIENT_VERSION + 1))

        # Ensure versioning starts from v1 if there are no versions
        SERVER_NEW_VERSION=${SERVER_NEW_VERSION:-1}
        CLIENT_NEW_VERSION=${CLIENT_NEW_VERSION:-1}

        # Set the new version numbers as environment variables
        echo "SERVER_NEW_VERSION=${SERVER_NEW_VERSION}" >> $GITHUB_ENV
        echo "CLIENT_NEW_VERSION=${CLIENT_NEW_VERSION}" >> $GITHUB_ENV

    - name: Build and push server Docker image
      working-directory: ./server
      run: |
        # Tag the server image with the correct version
        docker build -t jugalb/${{ env.DOCKER_REPO }}:${{ env.DOCKER_IMG_SERVER }}-${{ env.SERVER_NEW_VERSION }} .
        docker push jugalb/${{ env.DOCKER_REPO }}:${{ env.DOCKER_IMG_SERVER }}-${{ env.SERVER_NEW_VERSION }}

    - name: Build and push client Docker image
      working-directory: ./client
      run: |
        # Tag the client image with the correct version
        docker build -t jugalb/${{ env.DOCKER_REPO }}:${{ env.DOCKER_IMG_CLIENT }}-${{ env.CLIENT_NEW_VERSION }} .
        docker push jugalb/${{ env.DOCKER_REPO }}:${{ env.DOCKER_IMG_CLIENT }}-${{ env.CLIENT_NEW_VERSION }}
